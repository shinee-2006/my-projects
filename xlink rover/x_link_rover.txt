#include <WiFi.h>
#include <WebServer.h>
#include <ESP32Servo.h>
const char* ssid = "ESP32_Robot";
const char* password = "12345678";
#define IN1 25
#define IN2 26
#define ENA 33
#define IN3 27
#define IN4 14
#define ENB 32
#define TRIG_LEFT 5
#define ECHO_LEFT 18
#define TRIG_RIGHT 19
#define ECHO_RIGHT 21
#define SERVO_PIN 13
Servo chassisServo;
WebServer server(80);
int baseSpeed = 200;
long getDistance(int trigPin, int echoPin)
{
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  long duration = pulseIn(echoPin, HIGH, 25000);
  if (duration == 0) return 100;
  return duration * 0.034 / 2;
}
void stopRobot()
{
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
}

void forward()
{
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void backward()
{
  digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
}

void left()
{
  digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void right()
{
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
}

void diagonalLeft()
{
  analogWrite(ENA, 120);
  analogWrite(ENB, 220);
  forward();
}

void diagonalRight()
{
  analogWrite(ENA, 220);
  analogWrite(ENB, 120);
  forward();
}
void handleRoot()
{
  String page =
  "<h2>Adaptive Chassis Robot</h2>"
  "<a href='/F'>Forward</a><br>"
  "<a href='/B'>Backward</a><br>"
  "<a href='/L'>Left</a><br>"
  "<a href='/R'>Right</a><br>"
  "<a href='/DL'>Diagonal Left</a><br>"
  "<a href='/DR'>Diagonal Right</a><br>"
  "<a href='/S'>Stop</a><br>";
  server.send(200, "text/html", page);
}
void setup()
{
  Serial.begin(115200);

  pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);
  pinMode(ENA, OUTPUT); pinMode(ENB, OUTPUT);

  analogWrite(ENA, baseSpeed);
  analogWrite(ENB, baseSpeed);

  pinMode(TRIG_LEFT, OUTPUT);
  pinMode(ECHO_LEFT, INPUT);
  pinMode(TRIG_RIGHT, OUTPUT);
  pinMode(ECHO_RIGHT, INPUT);

  chassisServo.attach(SERVO_PIN);
  chassisServo.write(90);   // Neutral position

  WiFi.softAP(ssid, password);
  Serial.print("ESP32 IP: ");
  Serial.println(WiFi.softAPIP());

  server.on("/", handleRoot);
  server.on("/F", [](){ analogWrite(ENA, baseSpeed); analogWrite(ENB, baseSpeed); forward(); server.send(200,"text/plain","Forward"); });
  server.on("/B", [](){ backward(); server.send(200,"text/plain","Backward"); });
  server.on("/L", [](){ left(); server.send(200,"text/plain","Left"); });
  server.on("/R", [](){ right(); server.send(200,"text/plain","Right"); });
  server.on("/DL", [](){ diagonalLeft(); server.send(200,"text/plain","Diagonal Left"); });
  server.on("/DR", [](){ diagonalRight(); server.send(200,"text/plain","Diagonal Right"); });
  server.on("/S", [](){ stopRobot(); server.send(200,"text/plain","Stop"); });

  server.begin();
}
void loop()
{
  server.handleClient();

  long leftDist = getDistance(TRIG_LEFT, ECHO_LEFT);
  long rightDist = getDistance(TRIG_RIGHT, ECHO_RIGHT);

  Serial.print("Left: ");
  Serial.print(leftDist);
  Serial.print(" cm  Right: ");
  Serial.println(rightDist);
  if (leftDist < 15 || rightDist < 15)
  {
    chassisServo.write(40);   // Contract chassis
  }
  else
  {
    chassisServo.write(110);  // Expand chassis
  }

  delay(100);
}
